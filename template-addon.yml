
parameters:
  addonFolder: ''
  addonImage: ''

steps:
  - script: sudo apt-get install -y jq curl
    displayName: 'Install JQ/curl'
  - script: |
      tag="$(cat ${{ parameters.addonFolder }}/config.json | jq --raw-output ".version")"
      metadata="$(curl -s https://hub.docker.com/v2/repositories/homeassistant/$(buildArch)-${{ parameters.addonImage }}/tags/$tag/ | jq --raw-output '.name // empty')"

      # Version Exists
      echo "$tag - $metadata"
      if [ "$metadata" = "$tag" ]; then
        exit 0
      fi

      # Download Builder
      sudo docker pull homeassistant/amd64-builder:$(versionBuilder)

      # Build new version
      sudo docker run --rm --privileged \
        -v ~/.docker:/root/.docker \
        -v /run/docker.sock:/run/docker.sock:rw -v $(pwd):/data:ro \
        homeassistant/amd64-builder:$(versionBuilder) \
        --addon "--$(buildArch)" -t /data/${{ parameters.addonFolder }} \
        --docker-hub homeassistant
    displayName: 'Build ${{ parameters.addonFolder }}'
